@page
@model CampusEvents.Pages.Organizer.QRScannerModel
@{
    ViewData["Title"] = "QR Code Scanner";
    Layout = "_OrganizerLayout";
}

<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/Organizer/Home">Home</a></li>
            <li class="breadcrumb-item"><a href="/Organizer/Events">My Events</a></li>
            @if (Model.Event != null)
            {
                <li class="breadcrumb-item"><a href="/Organizer/EventDetails?id=@Model.Event.Id">@Model.Event.Title</a></li>
            }
            <li class="breadcrumb-item active">QR Scanner</li>
        </ol>
    </nav>

    <div class="row mb-4">
        <div class="col">
            <h1 class="display-4"><i class="bi bi-qr-code-scan"></i> Ticket Validation</h1>
            @if (Model.Event != null)
            {
                <p class="lead">Scanning for: <strong>@(Model.Event.Title.Length <= 90? Model.Event.Title:
                                            Model.Event.Title.Substring(0, 87) + "....")</strong></p>
            }
        </div>
    </div>

    @if (Model.Event == null)
    {
        <div class="alert alert-danger">
            <h4>Event Not Found</h4>
            <p>Please select an event to scan tickets for.</p>
            <a href="/Organizer/Events" class="btn btn-primary">Back to My Events</a>
        </div>
    }
    else
    {
        <div class="row">
            <!-- Left Column - Scanner -->
            <div class="col-lg-7">
                <!-- Camera Scanner -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-camera"></i> Scan QR Code</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Use your device's camera to scan ticket QR codes for instant validation.
                        </p>

                        <!-- Camera Scanner Container -->
                        <div id="qr-reader" style="width: 100%;"></div>
                        <div id="qr-reader-results" class="mt-3"></div>

                        <!-- Scanner Controls -->
                        <div class="mt-3 d-grid gap-2">
                            <button id="start-scan-btn" class="btn btn-success btn-lg" onclick="startScanner()">
                                <i class="bi bi-camera-fill"></i> Start Camera
                            </button>
                            <button id="stop-scan-btn" class="btn btn-danger" onclick="stopScanner()" style="display: none;">
                                <i class="bi bi-stop-circle"></i> Stop Camera
                            </button>
                        </div>

                        <!-- Alternative: File Upload -->
                        <hr class="my-4">
                        <p class="text-muted small">
                            <strong>Alternative:</strong> Upload QR code image
                        </p>
                        <div class="mb-3">
                            <input type="file" class="form-control" id="qr-file-input" accept="image/*" onchange="handleFileUpload(event)">
                            <small class="text-muted">Select a QR code image from your device</small>
                        </div>

                        <!-- Alternative: Manual Code Entry -->
                        <hr class="my-4">
                        <p class="text-muted small">
                            <strong>Alternative:</strong> Enter ticket code manually
                        </p>

                        <form method="post" asp-page-handler="ValidateCode" id="validate-form">
                            <input type="hidden" name="eventId" value="@Model.Event.Id" />
                            <div class="input-group">
                                <input type="text" class="form-control" name="ticketCode" id="ticketCode"
                                       placeholder="Enter ticket unique code or paste from QR" required />
                                <button type="submit" class="btn btn-outline-secondary">
                                    <i class="bi bi-key"></i> Validate
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Scan Result -->
                @if (!string.IsNullOrEmpty(Model.ResultMessage))
                {
                    <div class="card shadow-sm border-@(Model.IsSuccess ? "success" : "danger")">
                        <div class="card-header bg-@(Model.IsSuccess ? "success" : "danger") text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-@(Model.IsSuccess ? "check-circle-fill" : "x-circle-fill")"></i>
                                Validation Result
                            </h5>
                        </div>
                        <div class="card-body">
                            <h4>@Model.ResultMessage</h4>

                            @if (Model.ValidatedTicket != null)
                            {
                                <hr>
                                <div class="row">
                                    <div class="col-sm-4 text-muted">Ticket ID:</div>
                                    <div class="col-sm-8"><strong>#@Model.ValidatedTicket.Id</strong></div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-sm-4 text-muted">Attendee:</div>
                                    <div class="col-sm-8"><strong>@Model.ValidatedTicket.User.Name</strong></div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-sm-4 text-muted">Email:</div>
                                    <div class="col-sm-8">@Model.ValidatedTicket.User.Email</div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-sm-4 text-muted">Claimed:</div>
                                    <div class="col-sm-8">@Model.ValidatedTicket.ClaimedAt.ToString("MMM dd, yyyy h:mm tt")</div>
                                </div>
                                @if (Model.ValidatedTicket.IsRedeemed && Model.ValidatedTicket.RedeemedAt.HasValue)
                                {
                                    <div class="row mt-2">
                                        <div class="col-sm-4 text-muted">Checked In:</div>
                                        <div class="col-sm-8 text-success">
                                            <strong>@Model.ValidatedTicket.RedeemedAt.Value.ToString("MMM dd, yyyy h:mm tt")</strong>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Right Column - Stats -->
            <div class="col-lg-5">
                <!-- Event Stats -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Event Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Total Tickets:</span>
                                <strong>@Model.Event.TicketsIssued</strong>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Checked In:</span>
                                <strong class="text-success">@Model.CheckedInCount</strong>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Not Checked In:</span>
                                <strong class="text-warning">@(Model.Event.TicketsIssued - Model.CheckedInCount)</strong>
                            </div>
                        </div>
                        <hr>
                        <div class="progress" style="height: 25px;">
                            @{
                                var checkInRate = Model.Event.TicketsIssued > 0
                                ? (Model.CheckedInCount * 100.0 / Model.Event.TicketsIssued)
                                : 0;
                            }
                            <div class="progress-bar bg-success" style="width: @checkInRate%">
                                @checkInRate.ToString("F1")% Checked In
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Check-ins -->
                @if (Model.RecentCheckIns.Any())
                {
                    <div class="card shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Check-ins</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                @foreach (var ticket in Model.RecentCheckIns.Take(10))
                                {
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong>@ticket.User.Name</strong><br>
                                                <small class="text-muted">
                                                    @ticket.RedeemedAt?.ToString("MMM dd, h:mm tt")
                                                </small>
                                            </div>
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle-fill"></i>
                                            </span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Back Button -->
        <div class="row mt-4">
            <div class="col">
                <a href="/Organizer/EventDetails?id=@Model.Event.Id" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Event Details
                </a>
            </div>
        </div>
    }
</div>

@section Styles {
    <style>
        .breadcrumb-item {
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
}

@section Scripts {
    <!-- html5-qrcode library for QR scanning (bundled locally) -->
    <script src="~/lib/html5-qrcode.min.js"></script>

    <script>
        let html5QrcodeScanner = null;
        let lastScannedCode = null;
        let lastScanTime = 0;
        const SCAN_COOLDOWN_MS = 3000; // Prevent duplicate scans within 3 seconds

        function startScanner() {
            const startBtn = document.getElementById('start-scan-btn');
            const stopBtn = document.getElementById('stop-scan-btn');

            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';

            html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader",
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0,
                    rememberLastUsedCamera: true
                },
                /* verbose= */ false
            );

            html5QrcodeScanner.render(onScanSuccess, onScanError);
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(error => {
                    console.error("Failed to clear scanner", error);
                });
                html5QrcodeScanner = null;
            }

            const startBtn = document.getElementById('start-scan-btn');
            const stopBtn = document.getElementById('stop-scan-btn');

            startBtn.style.display = 'block';
            stopBtn.style.display = 'none';

            document.getElementById('qr-reader-results').innerHTML = '';
        }

        function onScanSuccess(decodedText, decodedResult) {
            const now = Date.now();

            // Rate limiting: prevent duplicate scans
            if (decodedText === lastScannedCode && (now - lastScanTime) < SCAN_COOLDOWN_MS) {
                return;
            }

            // Client-side validation: ensure payload is well-formed signed token
            try {
                const token = JSON.parse(decodedText.trim());
                if (!token.Payload || !token.Signature) {
                    throw new Error('Missing Payload or Signature');
                }
            } catch (e) {
                document.getElementById('qr-reader-results').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> <strong>Invalid QR Code:</strong> Not a valid signed ticket token.
                        <br><small>This may be an old or forged ticket. Please contact support if you believe this is an error.</small>
                    </div>
                `;
                return; // Don't submit malformed codes to server
            }

            lastScannedCode = decodedText;
            lastScanTime = now;

            // Display scanned code
            document.getElementById('qr-reader-results').innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-qr-code"></i> <strong>Code Scanned:</strong> ${decodedText.substring(0, 20)}...
                    <br><small>Validating ticket...</small>
                </div>
            `;

            // Auto-fill the manual entry field
            document.getElementById('ticketCode').value = decodedText;

            // Auto-submit the form for validation
            setTimeout(() => {
                document.getElementById('validate-form').submit();
            }, 500);
        }

        function onScanError(error) {
            // Ignore scanning errors (they're common while scanning)
            // Only log actual errors, not "No QR code found" messages
            if (!error.includes("NotFoundException")) {
                console.warn(`QR Scan Error: ${error}`);
            }
        }

        // Handle file upload for QR code decoding
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            // Check if html5-qrcode is available
            if (typeof Html5Qrcode === 'undefined') {
                alert('QR code scanner library not available. Please use manual entry.');
                return;
            }

            const html5QrCode = new Html5Qrcode("qr-reader");

            document.getElementById('qr-reader-results').innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-hourglass-split"></i> Decoding QR code from image...
                </div>
            `;

            html5QrCode.scanFile(file, true)
                .then(decodedText => {
                    // Validate and process the decoded text (same as camera scan)
                    try {
                        const token = JSON.parse(decodedText.trim());
                        if (!token.Payload || !token.Signature) {
                            throw new Error('Missing Payload or Signature');
                        }

                        document.getElementById('qr-reader-results').innerHTML = `
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i> <strong>QR Code Decoded Successfully!</strong>
                                <br><small>Validating ticket...</small>
                            </div>
                        `;

                        // Auto-fill and submit
                        document.getElementById('ticketCode').value = decodedText;
                        setTimeout(() => {
                            document.getElementById('validate-form').submit();
                        }, 500);

                    } catch (e) {
                        document.getElementById('qr-reader-results').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-x-circle"></i> <strong>Invalid QR Code:</strong> Not a valid signed ticket token.
                                <br><small>This may be an old or forged ticket.</small>
                            </div>
                        `;
                    }

                    // Clear the file input
                    event.target.value = '';
                })
                .catch(err => {
                    document.getElementById('qr-reader-results').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> <strong>Failed to decode QR code from image.</strong>
                            <br><small>${err}</small>
                        </div>
                    `;
                    event.target.value = '';
                });
        }

        // Auto-start scanner on page load for better UX
        document.addEventListener('DOMContentLoaded', function() {
            // Check if html5-qrcode library loaded successfully
            if (typeof Html5QrcodeScanner === 'undefined') {
                document.getElementById('qr-reader').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>QR Scanner Unavailable</strong><br>
                        The QR code scanning library failed to load. This may be due to network issues or blocked CDN access.
                        <br><br>
                        <strong>Please use manual code entry below.</strong>
                    </div>
                `;
                document.getElementById('start-scan-btn').disabled = true;
                return;
            }

            // Only auto-start if there's no result message (fresh page load)
            const resultMessage = '@Html.Raw(Model.ResultMessage ?? "")';
            if (!resultMessage) {
                setTimeout(startScanner, 500);
            }
        });
    </script>
}