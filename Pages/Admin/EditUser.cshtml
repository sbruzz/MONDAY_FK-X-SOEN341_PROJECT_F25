@page
@model EditUserModel
@{
    ViewData["Title"] = "Edit User";
    Layout = "_AdminLayout";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-person-gear"></i> Edit User</h1>
        <a href="/Admin/Users" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back to Users</a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">User Information</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        <input type="hidden" asp-for="User.Id" />
                        <input type="hidden" asp-for="User.PasswordHash" />
                        <input type="hidden" asp-for="User.CreatedAt" />

                        <!-- Basic Information -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="name" class="form-label">Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" asp-for="User.Name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" asp-for="User.Email" required>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label for="role" class="form-label">Role <span class="text-danger">*</span></label>
                                <select class="form-select" id="role" asp-for="User.Role" onchange="toggleRoleFields()">
                                    <option value="0">Student</option>
                                    <option value="1">Organizer</option>
                                    <option value="2">Admin</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="status" class="form-label">Approval Status <span class="text-danger">*</span></label>
                                <select class="form-select" id="status" asp-for="User.ApprovalStatus">
                                    <option value="0">Pending</option>
                                    <option value="1">Approved</option>
                                    <option value="2">Rejected</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Account Created</label>
                                <input type="text" class="form-control" value="@Model.User.CreatedAt.ToString("MMM dd, yyyy")" readonly>
                            </div>
                        </div>

                        <!-- Student-specific Fields -->
                        <div id="studentFields" style="display: none;">
                            <h5 class="mb-3"><i class="bi bi-mortarboard"></i> Student Information</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="studentId" class="form-label">Student ID</label>
                                    <input type="text" class="form-control" id="studentId" asp-for="User.StudentId" placeholder="e.g., 40123456">
                                </div>
                                <div class="col-md-6">
                                    <label for="phoneNumber" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phoneNumber" asp-for="User.PhoneNumber" placeholder="e.g., (514) 123-4567">
                                </div>
                            </div>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="program" class="form-label">Program</label>
                                    <input type="text" class="form-control" id="program" asp-for="User.Program" placeholder="e.g., Computer Science">
                                </div>
                                <div class="col-md-6">
                                    <label for="year" class="form-label">Year of Study</label>
                                    <select class="form-select" id="year" asp-for="User.YearOfStudy">
                                        <option value="">Select year...</option>
                                        <option value="1st Year">1st Year</option>
                                        <option value="2nd Year">2nd Year</option>
                                        <option value="3rd Year">3rd Year</option>
                                        <option value="4th Year">4th Year</option>
                                        <option value="Graduate">Graduate</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Organizer-specific Fields -->
                        <div id="organizerFields" style="display: none;">
                            <h5 class="mb-3"><i class="bi bi-building"></i> Organizer Information</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="organization" class="form-label">Organization</label>
                                    <select class="form-select" id="organization" asp-for="User.OrganizationId">
                                        <option value="">Select organization...</option>
                                        @foreach (var org in Model.Organizations)
                                        {
                                            <option value="@org.Id">@org.Name</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="position" class="form-label">Position</label>
                                    <input type="text" class="form-control" id="position" asp-for="User.Position" placeholder="e.g., President, Coordinator">
                                </div>
                            </div>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="department" class="form-label">Department</label>
                                    <input type="text" class="form-control" id="department" asp-for="User.Department" placeholder="e.g., Computer Science">
                                </div>
                                <div class="col-md-6">
                                    <label for="orgPhone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="orgPhone" asp-for="User.PhoneNumber" placeholder="e.g., (514) 123-4567">
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Save Changes
                            </button>
                            <a href="/Admin/Users" class="btn btn-outline-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Info Sidebar -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Quick Info</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">User ID</small>
                        <p class="mb-0"><strong>#@Model.User.Id</strong></p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Current Role</small>
                        <p class="mb-0">
                            @if (Model.User.Role == CampusEvents.Models.UserRole.Student)
                            {
                                <span class="badge bg-info">Student</span>
                            }
                            else if (Model.User.Role == CampusEvents.Models.UserRole.Organizer)
                            {
                                <span class="badge bg-success">Organizer</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Admin</span>
                            }
                        </p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Current Status</small>
                        <p class="mb-0">
                            @if (Model.User.ApprovalStatus == CampusEvents.Models.ApprovalStatus.Pending)
                            {
                                <span class="badge bg-warning">Pending</span>
                            }
                            else if (Model.User.ApprovalStatus == CampusEvents.Models.ApprovalStatus.Approved)
                            {
                                <span class="badge bg-success">Approved</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Rejected</span>
                            }
                        </p>
                    </div>
                    <div>
                        <small class="text-muted">Member Since</small>
                        <p class="mb-0"><strong>@Model.User.CreatedAt.ToString("MMMM dd, yyyy")</strong></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Profile Section -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show mt-4">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show mt-4">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model.DriverProfile != null)
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-car-front-fill"></i> Driver Profile</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <small class="text-muted">Driver Status</small>
                                    <p class="mb-0">
                                        <span class="badge bg-@(Model.DriverProfile.Status == CampusEvents.Models.DriverStatus.Active ? "success" : Model.DriverProfile.Status == CampusEvents.Models.DriverStatus.Pending ? "warning" : "danger")">
                                            @Model.DriverProfile.Status
                                        </span>
                                    </p>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">Vehicle Type</small>
                                    <p class="mb-0"><strong>@Model.DriverProfile.VehicleType</strong></p>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">Capacity</small>
                                    <p class="mb-0"><strong>@Model.DriverProfile.Capacity passengers</strong></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                @if (!string.IsNullOrEmpty(Model.DriverProfile.LicensePlate))
                                {
                                    <div class="mb-3">
                                        <small class="text-muted">License Plate</small>
                                        <p class="mb-0"><strong>@Model.DriverProfile.LicensePlate</strong></p>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(Model.DriverProfile.AccessibilityFeatures))
                                {
                                    <div class="mb-3">
                                        <small class="text-muted">Accessibility Features</small>
                                        <p class="mb-0">@Model.DriverProfile.AccessibilityFeatures.Replace(",", ", ")</p>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(Model.DriverProfile.SecurityFlags))
                                {
                                    <div class="mb-3">
                                        <small class="text-muted">Security Flags</small>
                                        <p class="mb-0 text-warning">@Model.DriverProfile.SecurityFlags</p>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="d-flex gap-2 mt-3">
                            @if (Model.DriverProfile.Status == CampusEvents.Models.DriverStatus.Pending)
                            {
                                <form method="post" asp-page-handler="ApproveDriver" class="d-inline">
                                    <input type="hidden" name="driverId" value="@Model.DriverProfile.Id" />
                                    <input type="hidden" name="userId" value="@Model.User.Id" />
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="bi bi-check-circle"></i> Approve Driver
                                    </button>
                                </form>
                            }
                            @if (Model.DriverProfile.Status == CampusEvents.Models.DriverStatus.Active)
                            {
                                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#suspendDriverModal">
                                    <i class="bi bi-slash-circle"></i> Suspend Driver
                                </button>
                            }
                            @if (Model.DriverProfile.Status == CampusEvents.Models.DriverStatus.Suspended)
                            {
                                <form method="post" asp-page-handler="UnsuspendDriver" class="d-inline">
                                    <input type="hidden" name="driverId" value="@Model.DriverProfile.Id" />
                                    <input type="hidden" name="userId" value="@Model.User.Id" />
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="bi bi-check-circle"></i> Unsuspend Driver
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Suspend Driver Modal -->
        <div class="modal fade" id="suspendDriverModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="post" asp-page-handler="SuspendDriver">
                        <input type="hidden" name="driverId" value="@Model.DriverProfile.Id" />
                        <input type="hidden" name="userId" value="@Model.User.Id" />
                        <div class="modal-header">
                            <h5 class="modal-title">Suspend Driver</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>Suspend <strong>@Model.User.Name</strong> as a driver?</p>
                            <p class="text-muted">This will prevent them from creating new carpool offers.</p>
                            <div class="mb-3">
                                <label class="form-label">Reason <span class="text-danger">*</span></label>
                                <textarea name="reason" class="form-control" rows="3" required></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Suspend Driver</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }

    <!-- Carpool Activity Section -->
    @if (Model.CarpoolOffersAsDriver.Any() || Model.CarpoolsAsPassenger.Any())
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-car-front"></i> Carpool Activity</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.CarpoolOffersAsDriver.Any())
                        {
                            <h6 class="mb-3">Rides Offered (@Model.CarpoolOffersAsDriver.Count)</h6>
                            <div class="table-responsive mb-4">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Event</th>
                                            <th>Departure</th>
                                            <th>Seats</th>
                                            <th>Passengers</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var offer in Model.CarpoolOffersAsDriver)
                                        {
                                            <tr>
                                                <td>@offer.Event.Title</td>
                                                <td>@offer.DepartureTime.ToString("MMM dd, HH:mm")</td>
                                                <td>@offer.SeatsAvailable available</td>
                                                <td>@offer.Passengers.Count joined</td>
                                                <td>
                                                    <span class="badge bg-@(offer.Status == CampusEvents.Models.CarpoolOfferStatus.Active ? "success" : offer.Status == CampusEvents.Models.CarpoolOfferStatus.Full ? "info" : "secondary")">
                                                        @offer.Status
                                                    </span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }

                        @if (Model.CarpoolsAsPassenger.Any())
                        {
                            <h6 class="mb-3">Rides Joined (@Model.CarpoolsAsPassenger.Count)</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Event</th>
                                            <th>Driver</th>
                                            <th>Departure</th>
                                            <th>Pickup Location</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var passenger in Model.CarpoolsAsPassenger)
                                        {
                                            <tr>
                                                <td>@passenger.Offer.Event.Title</td>
                                                <td>@passenger.Offer.Driver.User.Name</td>
                                                <td>@passenger.Offer.DepartureTime.ToString("MMM dd, HH:mm")</td>
                                                <td>@passenger.PickupLocation</td>
                                                <td>
                                                    <span class="badge bg-@(passenger.Status == CampusEvents.Models.PassengerStatus.Confirmed ? "success" : passenger.Status == CampusEvents.Models.PassengerStatus.Pending ? "warning" : "secondary")">
                                                        @passenger.Status
                                                    </span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Room Management Section -->
    @if (Model.ManagedRooms.Any() || Model.UserRentals.Any())
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-door-open"></i> Room Management</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.ManagedRooms.Any())
                        {
                            <h6 class="mb-3">Managed Rooms (@Model.ManagedRooms.Count)</h6>
                            <div class="table-responsive mb-4">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Room Name</th>
                                            <th>Address</th>
                                            <th>Capacity</th>
                                            <th>Status</th>
                                            <th>Rentals</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var room in Model.ManagedRooms)
                                        {
                                            <tr>
                                                <td><strong>@room.Name</strong></td>
                                                <td>@room.Address</td>
                                                <td>@room.Capacity</td>
                                                <td>
                                                    <span class="badge bg-@(room.Status == CampusEvents.Models.RoomStatus.Enabled ? "success" : "danger")">
                                                        @room.Status
                                                    </span>
                                                </td>
                                                <td>@room.Rentals.Count total</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }

                        @if (Model.UserRentals.Any())
                        {
                            <h6 class="mb-3">Room Rental Requests (@Model.UserRentals.Count)</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Room</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                            <th>Purpose</th>
                                            <th>Status</th>
                                            <th>Cost</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var rental in Model.UserRentals)
                                        {
                                            <tr>
                                                <td>@rental.Room.Name</td>
                                                <td>@rental.StartTime.ToString("MMM dd, HH:mm")</td>
                                                <td>@rental.EndTime.ToString("MMM dd, HH:mm")</td>
                                                <td>@rental.Purpose</td>
                                                <td>
                                                    <span class="badge bg-@(rental.Status == CampusEvents.Models.RentalStatus.Approved ? "success" : rental.Status == CampusEvents.Models.RentalStatus.Pending ? "warning" : "secondary")">
                                                        @rental.Status
                                                    </span>
                                                </td>
                                                <td>
                                                    @if (rental.TotalCost.HasValue)
                                                    {
                                                        <span>$@rental.TotalCost.Value.ToString("F2")</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">Free</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
<script>
    function toggleRoleFields() {
        const role = document.getElementById('role').value;
        const studentFields = document.getElementById('studentFields');
        const organizerFields = document.getElementById('organizerFields');

        // Hide all fields first
        studentFields.style.display = 'none';
        organizerFields.style.display = 'none';

        // Show relevant fields based on role
        if (role === '0') { // Student
            studentFields.style.display = 'block';
        } else if (role === '1') { // Organizer
            organizerFields.style.display = 'block';
        }
    }

    // Call on page load to show correct fields
    document.addEventListener('DOMContentLoaded', toggleRoleFields);
</script>
}
