@page
@model CampusEvents.Pages.Admin.DriversModel
@{
    ViewData["Title"] = "Manage Drivers";
    Layout = "_AdminLayout";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-car-front-fill"></i> Driver Management</h1>
        <a href="/Admin/Home" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Active Drivers</h5>
                    <h2>@Model.Drivers.Count(d => d.Status == CampusEvents.Models.DriverStatus.Active)</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">Pending Approval</h5>
                    <h2>@Model.Drivers.Count(d => d.Status == CampusEvents.Models.DriverStatus.Pending)</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">Suspended</h5>
                    <h2>@Model.Drivers.Count(d => d.Status == CampusEvents.Models.DriverStatus.Suspended)</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Flagged</h5>
                    <h2>@Model.Drivers.Count(d => d.SecurityFlags.Contains("flagged") || d.SecurityFlags.Contains("suspended"))</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link @(Model.StatusFilter == null ? "active" : "")" href="?status=all">
                All (@Model.Drivers.Count)
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(Model.StatusFilter == "Pending" ? "active" : "")" href="?status=Pending">
                Pending (@Model.Drivers.Count(d => d.Status == CampusEvents.Models.DriverStatus.Pending))
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(Model.StatusFilter == "Active" ? "active" : "")" href="?status=Active">
                Active (@Model.Drivers.Count(d => d.Status == CampusEvents.Models.DriverStatus.Active))
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(Model.StatusFilter == "Suspended" ? "active" : "")" href="?status=Suspended">
                Suspended (@Model.Drivers.Count(d => d.Status == CampusEvents.Models.DriverStatus.Suspended))
            </a>
        </li>
    </ul>

    <!-- Drivers Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Driver</th>
                            <th>Type</th>
                            <th>Vehicle</th>
                            <th>Capacity</th>
                            <th>Status</th>
                            <th>Offers</th>
                            <th>Security</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var driver in Model.Drivers)
                        {
                            <tr>
                                <td>
                                    <strong>@driver.User.Name</strong><br />
                                    <small class="text-muted">@driver.User.Email</small><br />
                                    <small class="text-muted">Registered: @driver.CreatedAt.ToString("MMM dd, yyyy")</small>
                                </td>
                                <td>
                                    <span class="badge bg-@(driver.DriverType == CampusEvents.Models.DriverType.Student ? "primary" : "secondary")">
                                        @driver.DriverType
                                    </span>
                                </td>
                                <td>
                                    @driver.VehicleType<br />
                                    @if (!string.IsNullOrEmpty(driver.LicensePlate))
                                    {
                                        <small class="text-muted">@driver.LicensePlate</small>
                                    }
                                </td>
                                <td>@driver.Capacity</td>
                                <td>
                                    <span class="badge bg-@(driver.Status == CampusEvents.Models.DriverStatus.Active ? "success" : driver.Status == CampusEvents.Models.DriverStatus.Pending ? "warning" : "danger")">
                                        @driver.Status
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-info">@driver.CarpoolOffers.Count offers</span><br />
                                    <small class="text-muted">
                                        @driver.CarpoolOffers.Count(o => o.Status == CampusEvents.Models.CarpoolOfferStatus.Active) active
                                    </small>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(driver.SecurityFlags))
                                    {
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-flag-fill"></i> Flagged
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (driver.Status == CampusEvents.Models.DriverStatus.Pending)
                                    {
                                        <form method="post" asp-page-handler="Approve" class="d-inline">
                                            <input type="hidden" name="driverId" value="@driver.Id" />
                                            <button type="submit" class="btn btn-sm btn-success">Approve</button>
                                        </form>
                                    }
                                    else if (driver.Status == CampusEvents.Models.DriverStatus.Active)
                                    {
                                        <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#suspendModal-@driver.Id">
                                            Suspend
                                        </button>
                                    }
                                    else if (driver.Status == CampusEvents.Models.DriverStatus.Suspended)
                                    {
                                        <form method="post" asp-page-handler="Unsuspend" class="d-inline">
                                            <input type="hidden" name="driverId" value="@driver.Id" />
                                            <button type="submit" class="btn btn-sm btn-success">Unsuspend</button>
                                        </form>
                                    }

                                    <!-- Suspend Modal -->
                                    <div class="modal fade" id="suspendModal-@driver.Id" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <form method="post" asp-page-handler="Suspend">
                                                    <input type="hidden" name="driverId" value="@driver.Id" />
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Suspend Driver</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p>Suspend <strong>@driver.User.Name</strong>?</p>
                                                        <p class="text-muted">This will cancel all active carpool offers.</p>
                                                        <div class="mb-3">
                                                            <label class="form-label">Reason for Suspension</label>
                                                            <textarea name="reason" class="form-control" rows="3" required></textarea>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-danger">Suspend Driver</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Passenger Management -->
    @if (Model.AllPassengers.Any())
    {
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-people"></i> Passenger Management (@Model.AllPassengers.Count)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Passenger</th>
                                <th>Event</th>
                                <th>Current Driver</th>
                                <th>Pickup Location</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var passenger in Model.AllPassengers.Where(p => p.Status == CampusEvents.Models.PassengerStatus.Confirmed || p.Status == CampusEvents.Models.PassengerStatus.Pending).Take(20))
                            {
                                <tr>
                                    <td>
                                        <strong>@passenger.Passenger.Name</strong><br />
                                        <small class="text-muted">@passenger.Passenger.Email</small>
                                    </td>
                                    <td>
                                        @passenger.Offer.Event.Title<br />
                                        <small class="text-muted">@passenger.Offer.DepartureTime.ToString("MMM dd, HH:mm")</small>
                                    </td>
                                    <td>
                                        @passenger.Offer.Driver.User.Name<br />
                                        <small class="text-muted">@passenger.Offer.Driver.VehicleType - @passenger.Offer.SeatsAvailable seats left</small>
                                    </td>
                                    <td>@passenger.PickupLocation</td>
                                    <td>
                                        <span class="badge bg-@(passenger.Status == CampusEvents.Models.PassengerStatus.Confirmed ? "success" : "warning")">
                                            @passenger.Status
                                        </span>
                                    </td>
                                    <td>
                                        <small>@passenger.JoinedAt.ToString("MMM dd")</small>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#reassignModal-@passenger.Id">
                                            <i class="bi bi-arrow-left-right"></i> Reassign
                                        </button>

                                        <!-- Reassign Modal -->
                                        <div class="modal fade" id="reassignModal-@passenger.Id" tabindex="-1">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <form method="post" asp-page-handler="ReassignPassenger">
                                                        <input type="hidden" name="passengerId" value="@passenger.Id" />
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">Reassign Passenger</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <p>Reassign <strong>@passenger.Passenger.Name</strong> from current ride?</p>
                                                            <div class="alert alert-info">
                                                                <strong>Current Ride:</strong> @passenger.Offer.Driver.User.Name (@passenger.Offer.Driver.VehicleType)<br />
                                                                <strong>Event:</strong> @passenger.Offer.Event.Title<br />
                                                                <strong>Departure:</strong> @passenger.Offer.DepartureTime.ToString("MMM dd, yyyy HH:mm")
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">New Carpool Offer ID <span class="text-danger">*</span></label>
                                                                <input type="number" name="newOfferId" class="form-control" required placeholder="Enter carpool offer ID" />
                                                                <div class="form-text">
                                                                    Note: The new offer must be for the same event (@passenger.Offer.Event.Title)
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                            <button type="submit" class="btn btn-primary">Reassign Passenger</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                @if (Model.AllPassengers.Count(p => p.Status == CampusEvents.Models.PassengerStatus.Confirmed || p.Status == CampusEvents.Models.PassengerStatus.Pending) > 20)
                {
                    <p class="text-muted text-center mt-3 mb-0">
                        Showing first 20 active passengers. Total: @Model.AllPassengers.Count(p => p.Status == CampusEvents.Models.PassengerStatus.Confirmed || p.Status == CampusEvents.Models.PassengerStatus.Pending)
                    </p>
                }
            </div>
        </div>
    }
</div>
