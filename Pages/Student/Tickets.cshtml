@page
@model CampusEvents.Pages.Student.TicketsModel
@{
    ViewData["Title"] = "My Tickets";
    Layout = "_StudentLayout";
}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-4"><i class="bi bi-ticket-perforated"></i> My Tickets</h1>
            <p class="lead">View and manage your event tickets</p>
        </div>
    </div>

    @if ((@Model.UpcomingCount+@Model.PastCount)== 0)
    {
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card text-center py-5">
                    <div class="card-body">
                        <i class="bi bi-ticket display-1 text-muted"></i>
                        <h3 class="mt-3">No Tickets Yet</h3>
                        <p class="text-muted">You haven't claimed any event tickets.</p>
                        <a href="/Student/Events" class="btn btn-primary mt-3">
                            <i class="bi bi-search"></i> Browse Events
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Filter Tabs -->
        <div class="tab-scroll mb-4">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link @(Model.Filter == "upcoming" ? "active" : "")" href="?filter=upcoming">
                        Upcoming (@Model.UpcomingCount)
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(Model.Filter == "past" ? "active" : "")" href="?filter=past">
                        Past Events (@Model.PastCount)
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(Model.Filter == "all" ? "active" : "")" href="?filter=all">
                        All (@(@Model.UpcomingCount+@Model.PastCount))
                    </a>
                </li>
            </ul>
        </div>

        <div class="row">
            @foreach (var ticket in Model.Tickets)
            {
                var isPastEvent = ticket.Event.EventDate < DateTime.UtcNow;

                <div class="col-lg-6 mb-4">
                    <div class="card @(isPastEvent ? "border-secondary" : "shadow-sm")">
                        <div class="card-header @(isPastEvent ? "bg-secondary text-white" : "bg-primary text-white")">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h5 class="mb-0">@ticket.Event.Title</h5>
                                </div>
                                <div class="col-auto">
                                    @if (ticket.IsRedeemed)
                                    {
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle-fill"></i> Checked In
                                        </span>
                                    }
                                    else if (isPastEvent)
                                    {
                                        <span class="badge bg-light text-dark">Past Event</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-light text-dark">Not Redeemed</span>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Event Details -->
                                <div class="col-md-7">
                                    <div class="mb-3">
                                        <h6 class="text-muted mb-2">Event Details</h6>

                                        <p class="mb-2">
                                            <i class="bi bi-calendar-event text-primary"></i>
                                            <strong>@ticket.Event.EventDate.ToString("MMMM dd, yyyy")</strong><br>
                                            <span class="ms-4">@ticket.Event.EventDate.ToString("h:mm tt")</span>
                                        </p>

                                        <p class="mb-2">
                                            <i class="bi bi-geo-alt text-primary"></i>
                                            @ticket.Event.Location
                                        </p>

                                        @if (ticket.Event.Organization != null)
                                        {
                                            <p class="mb-2">
                                                <i class="bi bi-building text-primary"></i>
                                                @ticket.Event.Organization.Name
                                            </p>
                                        }
                                    </div>

                                    <div class="mb-2">
                                        <h6 class="text-muted mb-2">Ticket Info</h6>
                                        <p class="small mb-1">
                                            <strong>Ticket ID:</strong> #@ticket.Id
                                        </p>
                                        <p class="small mb-1">
                                            <strong>Claimed:</strong> @ticket.ClaimedAt.ToString("MMM dd, yyyy h:mm tt")
                                        </p>
                                        @if (ticket.IsRedeemed && ticket.RedeemedAt.HasValue)
                                        {
                                            <p class="small mb-1 text-success">
                                                <strong>Checked In:</strong> @ticket.RedeemedAt.Value.ToString("MMM dd, yyyy h:mm tt")
                                            </p>
                                        }
                                    </div>
                                </div>

                                <!-- QR Code (pre-generated in page model) -->
                                <div class="col-md-5 text-center">
                                    <div class="bg-light p-3 rounded">
                                        <p class="small text-muted mb-2">Scan to Check In</p>
                                        @if (Model.TicketQRCodes.ContainsKey(ticket.Id))
                                        {
                                            <img src="data:image/png;base64,@Model.TicketQRCodes[ticket.Id]"
                                                 alt="Ticket QR Code"
                                                 class="img-fluid"
                                                 style="max-width: 200px; border: 2px solid #dee2e6; border-radius: 8px;">
                                        }
                                        else
                                        {
                                            <div class="alert alert-warning">QR Code not available</div>
                                        }
                                        <p class="small text-muted mt-2 mb-0">
                                            Code: <code>@ticket.UniqueCode.Substring(0, 8)...</code>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-white">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <a href="/Student/EventDetails?id=@ticket.Event.Id" class="btn btn-outline-primary btn-sm w-100">
                                        <i class="bi bi-info-circle"></i> Event Details
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100"
                                            onclick="downloadTicket(event, @ticket.Id)">
                                        <i class="bi bi-download"></i> Download QR
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@section Styles {
    <style>
        /* Responsive tab scrolling */
        .tab-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-scroll .nav-tabs {
            flex-wrap: nowrap;
            gap: 0.25rem;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-scroll .nav-link {
            white-space: nowrap;
        }

        .tab-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .tab-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .tab-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .tab-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
}

@section Scripts {
    <script>
        function downloadTicket(event, ticketId) {
            console.log('Download ticket clicked for ticket ID:', ticketId);

            try {
                // Find the ticket card and extract details
                const ticketCard = event.target.closest('.card');
                console.log('Found ticket card:', ticketCard);

                const qrImage = ticketCard.querySelector('img[alt="Ticket QR Code"]');
                const eventTitle = ticketCard.querySelector('.card-header h5').textContent.trim();

                // Extract event details from the card
                const cardBody = ticketCard.querySelector('.card-body');
                const eventDateText = cardBody.querySelector('strong').textContent;
                const eventTimeText = cardBody.querySelector('.ms-4').textContent;
                const eventLocation = cardBody.querySelectorAll('.mb-2')[1].textContent.trim();
                const ticketIdText = cardBody.querySelector('p.small strong').parentElement.textContent.replace('Ticket ID:', '').trim();
                const claimedText = cardBody.querySelectorAll('p.small')[1].textContent.replace('Claimed:', '').trim();

                console.log('Event details extracted');

                // Create canvas for the ticket
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // Set canvas dimensions (width x height)
                canvas.width = 800;
                canvas.height = 1000;

                // Background gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#f5ebe0');
                gradient.addColorStop(1, '#ffffff');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Header section with color
                ctx.fillStyle = '#d5bdaf';
                ctx.fillRect(0, 0, canvas.width, 120);

                // Event title
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 32px Arial, sans-serif';
                ctx.textAlign = 'center';
                const titleLines = wrapText(ctx, eventTitle, canvas.width - 40, 40);
                titleLines.forEach((line, index) => {
                    ctx.fillText(line, canvas.width / 2, 50 + (index * 40));
                });

                // "EVENT TICKET" label
                ctx.fillStyle = '#3d3d3d';
                ctx.font = 'bold 24px Arial, sans-serif';
                ctx.fillText('EVENT TICKET', canvas.width / 2, 170);

                // Draw QR Code
                const qrSize = 300;
                const qrX = (canvas.width - qrSize) / 2;
                const qrY = 210;

                // Load and draw QR image
                const img = new Image();
                img.onload = function() {
                    // Draw white background for QR
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(qrX - 10, qrY - 10, qrSize + 20, qrSize + 20);

                    // Draw border
                    ctx.strokeStyle = '#d5bdaf';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(qrX - 10, qrY - 10, qrSize + 20, qrSize + 20);

                    // Draw QR code
                    ctx.drawImage(img, qrX, qrY, qrSize, qrSize);

                    // Event Details Section
                    let yPos = qrY + qrSize + 40;
                    ctx.textAlign = 'left';

                    // Date & Time
                    ctx.fillStyle = '#d5bdaf';
                    ctx.font = 'bold 20px Arial, sans-serif';
                    ctx.fillText('üìÖ DATE & TIME', 60, yPos);

                    ctx.fillStyle = '#3d3d3d';
                    ctx.font = '18px Arial, sans-serif';
                    ctx.fillText(eventDateText, 60, yPos + 30);
                    ctx.fillText(eventTimeText, 60, yPos + 55);

                    // Location
                    yPos += 100;
                    ctx.fillStyle = '#d5bdaf';
                    ctx.font = 'bold 20px Arial, sans-serif';
                    ctx.fillText('üìç LOCATION', 60, yPos);

                    ctx.fillStyle = '#3d3d3d';
                    ctx.font = '18px Arial, sans-serif';
                    const locationLines = wrapText(ctx, eventLocation, canvas.width - 120, 18);
                    locationLines.forEach((line, index) => {
                        ctx.fillText(line, 60, yPos + 30 + (index * 25));
                    });

                    // Ticket Information
                    yPos += 80;
                    ctx.fillStyle = '#d5bdaf';
                    ctx.font = 'bold 20px Arial, sans-serif';
                    ctx.fillText('üé´ TICKET INFORMATION', 60, yPos);

                    ctx.fillStyle = '#3d3d3d';
                    ctx.font = '16px Arial, sans-serif';
                    ctx.fillText(`Ticket ID: ${ticketIdText}`, 60, yPos + 30);
                    ctx.fillText(`Claimed: ${claimedText}`, 60, yPos + 55);

                    // Important Information Box
                    yPos += 100;

                    // Draw box background
                    ctx.fillStyle = '#fff3cd';
                    ctx.fillRect(40, yPos - 15, canvas.width - 80, 150);
                    ctx.strokeStyle = '#ffc107';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(40, yPos - 15, canvas.width - 80, 150);

                    ctx.fillStyle = '#856404';
                    ctx.font = 'bold 18px Arial, sans-serif';
                    ctx.fillText('‚ö†Ô∏è IMPORTANT INFORMATION', 60, yPos + 10);

                    ctx.font = '14px Arial, sans-serif';
                    ctx.fillText('‚Ä¢ Please arrive 15 minutes before the event start time', 60, yPos + 40);
                    ctx.fillText('‚Ä¢ Present this QR code at the entrance for check-in', 60, yPos + 60);
                    ctx.fillText('‚Ä¢ Tickets are non-refundable but exchangeable', 60, yPos + 80);
                    ctx.fillText('‚Ä¢ Contact the organizer for any changes or issues', 60, yPos + 100);

                    // Footer
                    yPos += 165;
                    ctx.fillStyle = '#6b6b6b';
                    ctx.font = '12px Arial, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('Generated by CampusEvents Platform', canvas.width / 2, yPos);
                    ctx.fillText(`Downloaded: ${new Date().toLocaleString()}`, canvas.width / 2, yPos + 20);

                    // Convert canvas to blob and download
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `ticket-${ticketId}-${eventTitle.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.png`;

                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        URL.revokeObjectURL(url);
                        console.log('Download triggered successfully!');
                    });
                };

                img.onerror = function() {
                    console.error('Failed to load QR code image');
                    alert('Failed to load QR code image. Please try again.');
                };

                img.src = qrImage.src;

            } catch (error) {
                console.error('Error downloading ticket:', error);
                alert('Error downloading QR code: ' + error.message);
            }
        }

        // Helper function to wrap text
        function wrapText(ctx, text, maxWidth, fontSize) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + ' ' + word).width;
                if (width < maxWidth) {
                    currentLine += ' ' + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }
    </script>
}
